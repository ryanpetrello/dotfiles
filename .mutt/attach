#!/bin/bash
set -f
rm -f ~/.mail/temporary/attached*

exec < /dev/tty 3>&1 > /dev/tty

printf %s "push <attach-file>" >&3

read -p "Attempt to attach from the clipboard? (y/n)" -n 1 -r
if [[ $REPLY =~ ^[Yy]$ ]]
then

    tempfile="`dirname ~/.mail/temporary/attached`/attached"
    clipboard=`pbpaste`
    if [[ $clipboard == http* ]]
    then
        suffix=`echo "$clipboard" | awk -F . '{print $NF}'`
        tempfile="$tempfile.$suffix"
        curl "$clipboard" -o $tempfile
    else
        suffix="png"
        tempfile="$tempfile.$suffix"
        pngpaste "$tempfile"
    fi
    osascript -e 'tell application "Mutt"' -e 'activate' -e 'tell application "System Events"' -e "keystroke \"$tempfile"\" -e 'keystroke return' -e 'end tell' -e 'end tell'
fi
